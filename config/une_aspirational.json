{
    "settings" :
    {
        "map type": "globe",
        "query limit": 72,
        "info page": "
    },
    "background": [
        {
            "type": "color",
            "color": "#82CAFAFF",
            "_comment": "light sky blue"
        },
        {
            "type": "tilejson",
            "url": "http://a.tiles.mapbox.com/v3/mousebird.map-2ebn78d1.json"
        }
    ],
    "styles": [
        {
            "name": "outline_style",
            "type": "vector",
            "color": "#FFFFFFFF",
            "width": 3.0,
            "fade": 0.5
        },
       {
           "name": "loft_style",
           "type": "loftpoly",
            "color ramp":
            [ "#33CCFF88", "#3399FF88", "#3366CC88", "#3333CC88", "#6633CC88", "#9933FF88", "#FF007F88", "#FF00FF88"],
           "fade": 0.5
       },
       {
            "name": "outline_label",
            "type": "label",
            "textColor": "#FFFFFFFF",
            "shadowColor": "#000000FF",
            "shadowSize": 1.0,
            "textHeight": 18.0,
            "fade": 0.5
       }
    ],
    "controls": [
         {
             "name": "data_set",
             "display name": "Data Sets",
             "type": "list",
             "default" : "1",
             "initial index" : 1,
             "value query": {
                 "type" : "json_list",
                 "query" : "data_set_list"
             }
         }
    ],
    "queries": [
        {
            "name": "main_query",
            "display name": "Stats By Country",
            "styles": ["outline_style","outline_label","loft_style"],
                "query": "http://mousebird.cartodb.com/api/v2/sql?format=GeoJSON&q=SELECT ne_110m_admin_0_map_units.the_geom,(0.1*(une_measurements.measurement-({data_set_min}))/({data_set_max}-({data_set_min}))+0.01) as height,((une_measurements.measurement-({data_set_min}))/({data_set_max}-({data_set_min}))) as color_ramp, ne_110m_admin_0_map_units.name FROM ne_110m_admin_0_map_units inner join une_nations on ne_110m_admin_0_map_units.adm0_a3 = une_nations.iso3 inner join une_measurements on une_nations.id = une_measurements.nation_id WHERE ST_Intersects(ne_110m_admin_0_map_units.the_geom,ST_SetSRID(ST_Point({taplon},{taplat}),4326)) AND une_measurements.data_set_id = {data_set}"
        },
        {
            "name": "max_query",
            "query": "http://mousebird.cartodb.com/api/v2/sql?q=SELECT MAX(measurement) FROM une_measurements where data_set_id = {data_set}"
        },
        {
            "name": "min_query",
            "query": "http://mousebird.cartodb.com/api/v2/sql?q=SELECT MIN(measurement) FROM une_measurements where data_set_id = {data_set}"
        },
        {
            "name": "data_set_list",
            "query" : "http://mousebird.cartodb.com/api/v2/sql?q=SELECT id as list_value,variable_name as display_name FROM une_data_sets WHERE display = true ORDER BY id"
        }
    ],
    "events": [
        {
            "type": "onTap",
            "actions":
            [
            	{"type" : "geo query",
            	 "query" : "main_query"}
            ]
        },
        {
            "type": "onConfig",
            "actions":
            [
                 { "type" : "var query",
                 "query": "max_query",
                 "var": "data_set_max"},
                 { "type": "var query",
                 "query": "min_query",
                 "var": "data_set_min"},
                { "type": "query clear"}
             ]
        },
        {
            "type": "onStartup",
            "actions":
            [
             { "type" : "var query",
               "query": "max_query",
               "var": "data_set_max"},
             { "type": "var query",
               "query": "min_query",
               "var": "data_set_min"}
             ]
        }
    ]
}
