{
    "settings" :
    {
        "map type": "globe"
    }
    "background": [
        {
            "type": "color",
            "color": "#82CAFAFF",
            "_comment": "light sky blue"
        },
        {
            "type": "tilejson",
            "url": "http://a.tiles.mapbox.com/v3/mousebird.map-2ebn78d1.json"
        }
    ],
    "styles": [
        {
            "name": "outline_style",
            "type": "vector",
            "color": "#FFFFFFFF",
            "width": 3.0,
            "fade": 0.5
        },
       {
           "name": "loft_style",
           "type": "loftpoly",
           "color": "#FF0000FF",
           "fade": 0.5
       }
    ],
    "controls": [
         {
             "name": "data_set",
             "display name": "Data Sets",
             "type": "list",
             "default" : "1",
             "value query": {
                 "type" : "json_list",
                 "query" : "data_set_list"
             }
         }
    ],
    "queries": [
        {
            "name": "main_query",
            "display name": "Stats By Country",
            "styles": ["outline_style","loft_style"],
            "query": "http://mousebird.cartodb.com/api/v2/sql?format=GeoJSON&q=SELECT table_10m_admin_0_map_subunits.the_geom,((une_measurements.measurement-{data_set_min})/({data_set_max}-{data_set_min}) as height,((une_measurements.measurement-{data_set_min})/({data_set_max}-{data_set_min}) as color_scale FROM table_10m_admin_0_map_subunits inner join une_nations on table_10m_admin_0_map_subunits.adm0_a3 = une_nations.iso3 inner join une_measurements on une_nations.id = une_measurements.nation_id WHERE ST_Intersects(table_10m_admin_0_map_subunits.the_geom,ST_SetSRID(ST_Point({taplon},{taplat}),4326)) AND une_measurements.data_set_id = {data_set}"
        },
        {
            "name": "max_query",
            "query": "http://mousebird.cartodb.com/api/v2/sql?q=SELECT MAX(measurement) FROM une_measurements where id = {data_set}"
        },
        {
            "name": "min_query",
            "query": "http://mousebird.cartodb.com/api/v2/sql?q=SELECT MIN(measurement) FROM une_measurements where id = {data_set}"
        },
        {
            "name": "data_set_list",
            "query" : "http://mousebird.cartodb.com/api/v2/sql?q=SELECT id as list_value,variable_name as display_name FROM une_data_sets order by id"
        }
    ],
    "events": [
        {
            "type": "onTap",
            "action": "query",
            "query": "main_query"
        },
        {
            "type": "onConfig",
            "actions":
            [
                 { "type" : "var query",
                 "query": "max_query",
                 "var": "data_set_max"},
                 { "type": "var query",
                 "query": "min_query",
                 "var": "data_set_min"}
             ]
        },
        {
            "type": "onStartup",
            "actions":
            [
             { "type" : "var query",
               "query": "max_query",
               "var": "data_set_max"},
             { "type": "var query",
               "query": "min_query",
               "var": "data_set_min"}
             ]
        }
    ]
}
